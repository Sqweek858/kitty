# ============================================================================
# Brad TUI Ultra - Tmux Configuration
# ============================================================================
# Enhanced tmux configuration optimized for Brad TUI Ultra
# Fixes welcome animation compatibility and improves overall experience

# True color support
set -ga terminal-overrides ',*:Tc'
set -g default-terminal "tmux-256color"

# Enable RGB color support
set -as terminal-overrides ',*:RGB'

# Mouse support
set -g mouse on

# Set prefix to Ctrl+Space (more comfortable than Ctrl+B)
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# Window and pane indexing starts at 1
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Increase scrollback buffer
set -g history-limit 50000

# Faster command sequences
set -s escape-time 0

# Aggressive resize
setw -g aggressive-resize on

# Status bar configuration
set -g status on
set -g status-interval 1
set -g status-position bottom
set -g status-justify left

# Status bar colors (matching Brad TUI Ultra theme)
set -g status-style "bg=#0f141e,fg=#64dcff"
set -g status-left-length 40
set -g status-right-length 80

# Status bar content
set -g status-left "#{?client_prefix,#[bg=#ff00ff]#[fg=#0a0a12]#[bold] ðŸŽ„ PREFIX #[default] ,#[bg=#64dcff]#[fg=#0a0a12]#[bold] ðŸŽ„ BRAD #[default] }#[fg=#64dcff]â”‚"
set -g status-right "#[fg=#64dcff]â”‚ #[fg=#ffaa00]#S #[fg=#64dcff]â”‚ #[fg=#64dcff]%H:%M:%S #[fg=#64dcff]â”‚ #[fg=#00ff7f]%Y-%m-%d "

# Window status format
setw -g window-status-format "#[fg=#909caa] #I:#W "
setw -g window-status-current-format "#[bg=#1a2030,fg=#00ffff,bold] #I:#W#{?window_zoomed_flag, ðŸ”,} #[default]"

# Pane borders (matching theme)
set -g pane-border-style "fg=#2a3040"
set -g pane-active-border-style "fg=#00ffff"

# Message style
set -g message-style "bg=#1a2030,fg=#00ffff,bold"
set -g message-command-style "bg=#1a2030,fg=#ff00ff,bold"

# ============================================================================
# Brad TUI Ultra Integration
# ============================================================================

# Hook to launch Brad TUI Ultra in the main pane when a new session starts
set-hook -g after-new-session 'run-shell "if [ -f ~/bin/brad_tui_ultra.py ]; then tmux send-keys -t 0 \"python3 ~/bin/brad_tui_ultra.py\" Enter; fi"'

# Create Brad visualization pane on the right (28% width)
set-hook -g client-attached 'run-shell "\
  if ! tmux list-panes -F \"#{pane_title}\" | grep -qx Brad; then \
    tmux split-window -h -p 28 \"\
      tmux rename-pane Brad; \
      env PYTHONUNBUFFERED=1 python3 ~/bin/brad_tui.py \
    \"; \
  fi \
"'

# ============================================================================
# Key Bindings
# ============================================================================

# Reload configuration
bind r source-file ~/.tmux.conf \; display "Configuration reloaded!"

# Split panes with more intuitive keys
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Navigate panes with Alt+arrow (no prefix needed)
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Resize panes with Ctrl+arrow
bind -n C-M-Left resize-pane -L 2
bind -n C-M-Right resize-pane -R 2
bind -n C-M-Up resize-pane -U 2
bind -n C-M-Down resize-pane -D 2

# Quick pane selection with prefix + number
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5

# Create new window
bind c new-window -c "#{pane_current_path}"

# Synchronize panes toggle
bind S set-window-option synchronize-panes\; display "Synchronize #{?pane_synchronized,ON,OFF}"

# Zoom toggle
bind z resize-pane -Z

# Copy mode with vim bindings
setw -g mode-keys vi
bind Escape copy-mode
bind P paste-buffer
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi r send-keys -X rectangle-toggle

# ============================================================================
# Brad TUI Specific Bindings
# ============================================================================

# Restart Brad main TUI (Prefix + B)
bind B respawn-pane -k -t 0 "python3 ~/bin/brad_tui_ultra.py"

# Restart Brad visualization (Prefix + Shift+B)
bind -n M-B respawn-pane -k -t '{pane_title=Brad}' 'env PYTHONUNBUFFERED=1 python3 ~/bin/brad_tui.py'

# Close Brad pane (Prefix + X)
bind X kill-pane -t "{pane_title=Brad}"

# Toggle Brad pane visibility (Prefix + T)
bind T if-shell "tmux list-panes -F \"#{pane_title}\" | grep -qx Brad" \
  "kill-pane -t \"{pane_title=Brad}\"" \
  "split-window -h -p 28 'tmux rename-pane Brad; env PYTHONUNBUFFERED=1 python3 ~/bin/brad_tui.py'"

# ============================================================================
# Appearance Enhancements
# ============================================================================

# Clock mode colors
setw -g clock-mode-colour "#00ffff"
setw -g clock-mode-style 24

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity off
setw -g window-status-activity-style "bg=#ff6b6b,fg=#0a0a12"

# Bell
set -g visual-bell off
set -g bell-action none

# Display pane numbers
set -g display-panes-time 2000
set -g display-panes-colour "#ff00ff"
set -g display-panes-active-colour "#00ffff"

# Display messages for longer
set -g display-time 2000

# ============================================================================
# Tmux Plugin Manager (Optional)
# ============================================================================

# List of plugins
# set -g @plugin 'tmux-plugins/tpm'
# set -g @plugin 'tmux-plugins/tmux-sensible'
# set -g @plugin 'tmux-plugins/tmux-resurrect'
# set -g @plugin 'tmux-plugins/tmux-continuum'
# set -g @plugin 'tmux-plugins/tmux-yank'

# Plugin settings
# set -g @resurrect-strategy-vim 'session'
# set -g @resurrect-strategy-nvim 'session'
# set -g @continuum-restore 'on'
# set -g @continuum-save-interval '15'

# Initialize TMUX plugin manager (keep this line at the very bottom)
# run '~/.tmux/plugins/tpm/tpm'

# ============================================================================
# Custom Status Bar Modules
# ============================================================================

# CPU and Memory display (requires custom script)
# set -g status-right "#[fg=#64dcff]â”‚ CPU: #(top -bn1 | grep \"Cpu(s)\" | sed \"s/.*, *\\([0-9.]*\\)%* id.*/\\1/\" | awk '{print 100 - $1\"%\"}') â”‚ MEM: #(free | grep Mem | awk '{printf \"%.1f%%\", $3/$2 * 100.0}') â”‚ #[fg=#ffaa00]#S #[fg=#64dcff]â”‚ #[fg=#64dcff]%H:%M:%S"

# Git branch display (if in git repo)
# set -g status-right "#[fg=#64dcff]â”‚ #(cd #{pane_current_path}; git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'no git') â”‚ %H:%M:%S"

# ============================================================================
# Performance Tuning
# ============================================================================

# Don't wait for escape sequence
set -sg escape-time 0

# Update status bar more frequently
set -g status-interval 1

# Set terminal title
set -g set-titles on
set -g set-titles-string "ðŸŽ„ Brad TUI Ultra - #S:#I:#W"

# Enable focus events
set -g focus-events on

# ============================================================================
# Special Features
# ============================================================================

# Nested tmux session support (Prefix + a sends prefix to inner session)
bind -n C-a send-prefix

# Quick session switcher (Prefix + s)
bind s choose-tree -Zs

# Quick window switcher (Prefix + w)
bind w choose-tree -Zw

# Detach session (Prefix + d)
bind d detach-client

# Kill session (Prefix + Shift+X)
bind X confirm-before -p "Kill session #S? (y/n)" kill-session

# ============================================================================
# Compatibility Settings
# ============================================================================

# Support for older tmux versions
if-shell "[ $(tmux -V | cut -d' ' -f2 | tr -d '[:alpha:]') -lt 2.9 ]" \
  "set -g window-status-current-bg '#1a2030'; set -g window-status-current-fg '#00ffff'"

# ============================================================================
# End of Configuration
# ============================================================================
